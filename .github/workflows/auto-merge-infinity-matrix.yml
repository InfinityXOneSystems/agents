---
name: Auto-Merge Infinity-Matrix PRs

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'infinity-matrix/**'

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    name: Auto-Merge Infinity-Matrix PR
    runs-on: ubuntu-latest
    # Only run on non-draft PRs
    if: github.event.pull_request.draft == false
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Verify PR affects infinity-matrix
        id: verify_path
        run: |
          echo "âœ… This PR affects infinity-matrix directory"
          echo "Will be auto-merged"
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "PR Title: ${{ github.event.pull_request.title }}"
          echo "Author: ${{ github.event.pull_request.user.login }}"

      - name: Enable auto-merge with squash
        id: auto_merge
        run: |
          echo "Enabling auto-merge for PR..."
          PR_NUM="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"
          gh pr merge "$PR_NUM" --auto --squash --repo "$REPO" || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add auto-merge comment
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"
          COMMENT="ðŸ¤– Auto-merge enabled for infinity-matrix changes."
          COMMENT="$COMMENT This PR will be automatically merged"
          COMMENT="$COMMENT once all checks pass."
          gh pr comment "$PR_NUM" --body "$COMMENT" --repo "$REPO"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Fallback job to force merge if auto-merge is not enabled
  force-merge:
    name: Force Merge if Ready
    runs-on: ubuntu-latest
    needs: auto-merge
    if: |
      github.event.pull_request.draft == false &&
      github.event.action == 'ready_for_review'
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Wait for other checks
        run: |
          echo "Waiting 30 seconds for other status checks..."
          sleep 30

      - name: Attempt force merge
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"
          echo "Attempting to merge PR #$PR_NUM..."
          gh pr merge "$PR_NUM" --squash --repo "$REPO" ||
            echo "Merge not ready or already merged"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
