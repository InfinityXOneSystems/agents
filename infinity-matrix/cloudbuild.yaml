# Google Cloud Build configuration for Infinity-Matrix System
# Builds and deploys both frontend and backend to Cloud Run

steps:
  # Step 1: Build Backend (Orchestration) Image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-backend'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/infinity-orchestration:latest'
      - '-t'
      - 'gcr.io/$PROJECT_ID/infinity-orchestration:$SHORT_SHA'
      - '-f'
      - 'orchestration/Dockerfile'
      - './orchestration'

  # Step 2: Push Backend Image to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-backend'
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/infinity-orchestration:$SHORT_SHA'

  # Step 3: Deploy Backend to Cloud Run
  - name: 'gcr.io/cloud-builders/gke-deploy'
    id: 'deploy-backend-cloudrun'
    args:
      - run
      - 'gcloud run deploy infinity-orchestration --image gcr.io/$PROJECT_ID/infinity-orchestration:$SHORT_SHA --platform managed --region us-central1 --memory 1Gi --cpu 1 --allow-unauthenticated --set-env-vars NODE_ENV=production,GOOGLE_CLOUD_PROJECT=$PROJECT_ID'

  # Step 4: Build Frontend Image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-frontend'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/infinity-frontend:latest'
      - '-t'
      - 'gcr.io/$PROJECT_ID/infinity-frontend:$SHORT_SHA'
      - '-f'
      - 'frontend/Dockerfile'
      - './frontend'

  # Step 5: Push Frontend Image to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-frontend'
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/infinity-frontend:$SHORT_SHA'

  # Step 6: Deploy Frontend to Cloud Run
  - name: 'gcr.io/cloud-builders/gke-deploy'
    id: 'deploy-frontend-cloudrun'
    args:
      - run
      - 'gcloud run deploy infinity-frontend --image gcr.io/$PROJECT_ID/infinity-frontend:$SHORT_SHA --platform managed --region us-central1 --memory 512Mi --cpu 1 --allow-unauthenticated --set-env-vars VITE_API_URL=https://infinity-orchestration-XXXX.a.run.app'

images:
  - 'gcr.io/$PROJECT_ID/infinity-orchestration:$SHORT_SHA'
  - 'gcr.io/$PROJECT_ID/infinity-frontend:$SHORT_SHA'

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'N1_HIGHCPU_8'

timeout: '3600s'
